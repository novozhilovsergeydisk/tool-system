{% extends 'inventory/base.html' %}

{% block content %}
<div class="row h-100 mt-3">
    
    <div class="col-md-5">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fa-solid fa-magnifying-glass"></i> Подбор товаров</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Откуда (Склад):</label>
                    <select id="selectWarehouse" class="form-select" onchange="filterAvailableItems()">
                        <option value="" selected disabled>- Выберите склад -</option>
                        {% for wh in warehouses %}<option value="{{ wh.id }}">{{ wh.name }}</option>{% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Поиск товара:</label>
                    <input type="text" id="searchInput" class="form-control" placeholder="Начните вводить название, артикул или S/N..." disabled onkeyup="filterAvailableItems()">
                </div>
                
                <div class="table-responsive border rounded bg-body" style="max-height: 500px;">
                    <table class="table table-hover table-custom mb-0 align-middle small">
                        <thead class="sticky-top">
                            <tr>
                                <th width="40" class="text-center"><i class="fa-solid fa-filter"></i></th>
                                <th>Наименование</th>
                                <th>S/N или Остаток</th>
                            </tr>
                        </thead>
                        <tbody id="resultsList">
                            <tr><td colspan="3" class="text-center text-body-secondary py-3">Сначала выберите склад</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-7">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fa-solid fa-cart-shopping"></i> Список к выдаче</h5>
                <span class="badge bg-white text-success" id="cartCount">0 поз.</span>
            </div>
            <div class="card-body d-flex flex-column">
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Кому (Сотрудник):</label>
                    <select id="selectEmployee" class="form-select">
                        <option value="" selected disabled>- Выберите сотрудника -</option>
                        {% for emp in employees %}
                            <option value="{{ emp.id }}">{{ emp.get_full_name|default:emp.username }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div id="employeeItemsBlock" style="display:none;" class="mt-2 mb-3 p-2 border rounded bg-body-tertiary">
                    <h6 class="text-body-secondary small mb-2 border-bottom pb-1">
                        <i class="fa-solid fa-briefcase"></i> Числится за сотрудником:
                    </h6>
                    <ul class="list-group list-group-flush small" id="employeeItemsList" style="max-height: 200px; overflow-y: auto;"></ul>
                </div>

                <div class="flex-grow-1 overflow-auto border rounded mb-3 bg-body">
                    <table class="table table-striped table-hover table-custom mb-0 align-middle small">
                        <thead class="sticky-top">
                            <tr>
                                <th width="40" class="text-center">Тип</th>
                                <th>Наименование</th>
                                <th width="100">Кол-во / S/N</th>
                                <th width="40"></th>
                            </tr>
                        </thead>
                        <tbody id="cartTableBody"></tbody>
                    </table>
                    <div id="emptyCartMsg" class="text-center text-body-secondary mt-5">Список пуст</div>
                </div>

                <button class="btn btn-success w-100 py-2 fw-bold" onclick="submitIssue()" id="btnSubmit" disabled>ОФОРМИТЬ ВЫДАЧУ</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="quickReturnModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Возврат</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Возвращаем: <strong id="retItemName"></strong></p><div class="mb-3" id="retQtyBlock"><label>Количество:</label><input type="number" id="retQty" class="form-control" min="1" value="1"></div><div class="mb-3"><label>На какой склад:</label><select id="retWarehouse" class="form-select">{% for wh in warehouses %}<option value="{{ wh.id }}">{{ wh.name }}</option>{% endfor %}</select></div><div class="mb-3"><label>Комментарий:</label><textarea id="retComment" class="form-control" rows="2"></textarea></div></div><div class="modal-footer"><button type="button" class="btn btn-success" onclick="confirmReturn()">Вернуть</button></div></div></div></div>
<div class="modal fade" id="quickWriteoffModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-danger text-white"><h5 class="modal-title">Списание</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="alert alert-warning small">Товар будет удален!</div><p>Списываем: <strong id="woItemName"></strong></p><div class="mb-3" id="woQtyBlock"><label>Количество:</label><input type="number" id="woQty" class="form-control" min="1" value="1"></div><div class="mb-3"><label>Причина:</label><textarea id="woComment" class="form-control" rows="2" required></textarea></div></div><div class="modal-footer"><button type="button" class="btn btn-danger" onclick="confirmWriteoff()">Списать</button></div></div></div></div>

<script>
    const allTools = {{ tools_json|safe }};
    const allConsumables = {{ consumables_json|safe }};
    let cart = [];
    let activeItem = null;

    const elWh = document.getElementById('selectWarehouse');
    const elSearch = document.getElementById('searchInput');
    const elResults = document.getElementById('resultsList');
    const elCartBody = document.getElementById('cartTableBody');
    const elEmptyMsg = document.getElementById('emptyCartMsg');
    const elCount = document.getElementById('cartCount');
    const elBtnSubmit = document.getElementById('btnSubmit');
    const elEmp = document.getElementById('selectEmployee');

    function filterAvailableItems() {
        const whId = parseInt(elWh.value);
        const query = elSearch.value.toLowerCase();
        if (!whId) { elSearch.disabled = true; elResults.innerHTML = '<tr><td colspan="3" class="text-center text-body-secondary py-3">Сначала выберите склад</td></tr>'; return; }
        elSearch.disabled = false;
        elResults.innerHTML = '';

        const tools = allTools.filter(t => t.wh_id === whId && !isInCart(t.id, 'tool'));
        const cons = allConsumables.filter(c => c.wh_id === whId && !isInCart(c.id, 'consumable'));
        const combined = [...tools, ...cons];
        const filtered = combined.filter(item => (item.name + ' ' + item.art + ' ' + (item.sn || '')).toLowerCase().includes(query));

        if (filtered.length === 0) { elResults.innerHTML = '<tr><td colspan="3" class="text-center text-body-secondary py-3">Ничего не найдено</td></tr>'; return; }

        filtered.forEach(item => {
            const isTool = (item.type === 'tool');
            const badge = isTool ? `<span class="badge bg-secondary">${item.sn}</span>` : `<span class="badge bg-info text-dark">Ост: ${item.max_qty}</span>`;
            const tr = document.createElement('tr');
            tr.style.cursor = 'pointer';
            tr.onclick = () => addToCart(item);
            
            // ИКОНКИ ВМЕСТО ТЕКСТА
            let icon = 'fa-box text-info'; // По умолчанию расходник
            let title = 'Расходник';
            
            if (item.type_label === 'Инструмент') { 
                icon = 'fa-hammer text-secondary'; 
                title = 'Инструмент'; 
            }
            else if (item.type_label === 'Экипировка') { 
                icon = 'fa-vest text-primary'; 
                title = 'Экипировка'; 
            }

            tr.innerHTML = `
                <td class="text-center"><i class="fa-solid ${icon} fs-6" title="${title}"></i></td>
                <td><div><strong>${item.name}</strong></div><div class="small text-body-secondary font-monospace">${item.art}</div></td>
                <td>${badge}</td>
            `;
            elResults.appendChild(tr);
        });
    }

    function addToCart(item) { cart.push({ ...item, qty_to_issue: 1 }); renderCart(); filterAvailableItems(); }
    function isInCart(id, type) { return cart.some(x => x.id === id && x.type === type); }
    
    function renderCart() {
        elCartBody.innerHTML = '';
        elCount.innerText = cart.length + ' поз.';
        if (cart.length === 0) { elEmptyMsg.style.display = 'block'; elBtnSubmit.disabled = true; } 
        else { elEmptyMsg.style.display = 'none'; elBtnSubmit.disabled = false; }

        cart.forEach((item, index) => {
            const tr = document.createElement('tr');
            let qtyHtml = item.type === 'tool' ? `<span class="badge bg-secondary">${item.sn}</span>` : `<input type="number" class="form-control form-control-sm" value="${item.qty_to_issue}" min="1" max="${item.max_qty}" onchange="updateQty(${index}, this.value)"><small class="text-body-secondary">max: ${item.max_qty}</small>`;
            
            // ИКОНКИ В КОРЗИНЕ
            let icon = 'fa-box text-info';
            if (item.type_label === 'Инструмент') icon = 'fa-hammer text-secondary';
            else if (item.type_label === 'Экипировка') icon = 'fa-vest text-primary';

            tr.innerHTML = `
                <td class="text-center"><i class="fa-solid ${icon}" title="${item.type_label}"></i></td>
                <td><div class="fw-bold">${item.name}</div><div class="small text-body-secondary">${item.art}</div></td>
                <td>${qtyHtml}</td>
                <td><button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${index})"><i class="fa-solid fa-times"></i></button></td>
            `;
            elCartBody.appendChild(tr);
        });
    }
    function removeFromCart(index) { cart.splice(index, 1); renderCart(); filterAvailableItems(); }
    function updateQty(index, val) { let v = parseInt(val); if(v<1)v=1; if(v>cart[index].max_qty)v=cart[index].max_qty; cart[index].qty_to_issue=v; }

    function submitIssue() {
        const empId = elEmp.value;
        if (!empId) { alert('Выберите сотрудника!'); return; }
        if (cart.length === 0) return;
        fetch("{% url 'bulk_issue' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
            body: JSON.stringify({ employee_id: empId, items: cart.map(i => ({ type: i.type, id: i.id, qty: i.qty_to_issue })) })
        }).then(r => { if(r.ok) window.location.href = "{% url 'tool_list' %}"; else alert('Ошибка!'); });
    }

    elEmp.addEventListener('change', loadEmployeeItems);
    function loadEmployeeItems() {
        const empId = elEmp.value;
        if (!empId) return;
        fetch(`/api/employee/${empId}/items/`)
            .then(response => response.json())
            .then(data => {
                const list = document.getElementById('employeeItemsList');
                const block = document.getElementById('employeeItemsBlock');
                list.innerHTML = '';
                let hasItems = false;
                
                const renderItem = (name, art, badge, type_label, type, id, maxQty) => {
                    hasItems = true;
                    let icon = 'fa-box text-info';
                    if (type_label === 'Инструмент') icon = 'fa-hammer text-secondary';
                    else if (type_label === 'Экипировка') icon = 'fa-vest text-primary';
                    
                    list.innerHTML += `
                    <li class="list-group-item bg-transparent py-2 border-0 border-bottom d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="me-2" style="width: 20px; text-align: center;">
                                <i class="fa-solid ${icon}" title="${type_label}"></i>
                            </div>
                            <div>
                                <div class="fw-bold">${name} ${badge}</div>
                                <div class="small text-body-secondary font-monospace">${art}</div>
                            </div>
                        </div>
                        <div class="btn-group ms-2">
                            <button class="btn btn-sm btn-outline-success py-0 px-2" onclick="openReturnModal('${type}', ${id}, '${name}', ${maxQty})" title="Вернуть"><i class="fa-solid fa-share"></i></button>
                            <button class="btn btn-sm btn-outline-danger py-0 px-2" onclick="openWriteoffModal('${type}', ${id}, '${name}', ${maxQty})" title="Списать"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </li>`;
                };

                data.tools.forEach(t => renderItem(t.name, t.art, `<span class="badge bg-secondary ms-1">${t.sn}</span>`, t.type_label, 'tool', t.id, 1));
                data.consumables.forEach(c => renderItem(c.name, c.art, `<span class="badge bg-info text-dark ms-1">${c.qty} шт.</span>`, c.type_label, 'consumable', c.id, c.qty));
                
                if (!hasItems) list.innerHTML = '<li class="list-group-item bg-transparent text-body-secondary py-1 border-0">Ничего не числится</li>';
                block.style.display = 'block';
            });
    }

    function openReturnModal(type, id, name, maxQty) { activeItem = { type, id }; document.getElementById('retItemName').innerText = name; document.getElementById('retQtyBlock').style.display = type === 'tool' ? 'none' : 'block'; document.getElementById('retQty').value = 1; document.getElementById('retQty').max = maxQty; new bootstrap.Modal(document.getElementById('quickReturnModal')).show(); }
    function confirmReturn() { if (!activeItem) return; fetch("{% url 'api_return_item' %}", { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' }, body: JSON.stringify({ type: activeItem.type, id: activeItem.id, warehouse_id: document.getElementById('retWarehouse').value, comment: document.getElementById('retComment').value, qty: document.getElementById('retQty').value }) }).then(r => { if (r.ok) { bootstrap.Modal.getInstance(document.getElementById('quickReturnModal')).hide(); loadEmployeeItems(); filterAvailableItems(); } else alert('Ошибка возврата'); }); }
    function openWriteoffModal(type, id, name, maxQty) { activeItem = { type, id }; document.getElementById('woItemName').innerText = name; document.getElementById('woQtyBlock').style.display = type === 'tool' ? 'none' : 'block'; document.getElementById('woQty').value = 1; document.getElementById('woQty').max = maxQty; document.getElementById('woComment').value = ''; new bootstrap.Modal(document.getElementById('quickWriteoffModal')).show(); }
    function confirmWriteoff() { if (!activeItem) return; if(!document.getElementById('woComment').value){alert("Причина?");return;} fetch("{% url 'api_writeoff_item' %}", { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' }, body: JSON.stringify({ type: activeItem.type, id: activeItem.id, comment: document.getElementById('woComment').value, qty: document.getElementById('woQty').value }) }).then(r => { if (r.ok) { bootstrap.Modal.getInstance(document.getElementById('quickWriteoffModal')).hide(); loadEmployeeItems(); } else alert('Ошибка списания'); }); }
</script>
{% endblock %}