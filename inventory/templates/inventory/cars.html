{% extends 'inventory/base.html' %}

{% block content %}
<div class="row h-100">
    <div class="col-md-4 border-end bg-body p-3" style="min-height: 85vh;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0"><i class="fa-solid fa-car-side"></i> Автомобили</h5>
            {% if user.is_staff %}
            <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#createCarModal">
                <i class="fa-solid fa-plus"></i> Создать
            </button>
            {% endif %}
        </div>
        
        <div class="list-group" id="carSidebar">
            {% for car in cars %}
            <a href="?car_id={{ car.id }}" class="list-group-item list-group-item-action {% if selected_car and selected_car.id == car.id %}active{% endif %}">
                <div class="d-flex w-100 justify-content-between align-items-start">
                    <h6 class="mb-1">
                        {{ car.name }}
                        {% if car.is_truck %}<i class="fa-solid fa-truck text-body-secondary small" title="Грузовой"></i>{% endif %}
                    </h6>
                    <small>
                        {% if car.status == 'PARKED' %} <span class="badge bg-success">На парковке</span>
                        {% elif car.status == 'ON_ROUTE' %} <span class="badge bg-warning text-dark">На выезде</span>
                        {% elif car.status == 'MAINTENANCE' %} <span class="badge bg-secondary">На ТО</span>
                        {% elif car.status == 'TECH_INSPECTION' %} <span class="badge bg-info text-dark">На Техосмотре</span>
                        {% elif car.status == 'BROKEN' %} <span class="badge bg-danger">СЛОМАН</span>
                        {% endif %}
                    </small>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-1">
                    <small class="font-monospace">{{ car.license_plate }}</small>
                    
                    <div class="d-flex gap-1">
                        {% if car.service_status == 'warning' %} <span class="badge bg-warning text-dark" title="Скоро ТО"><i class="fa-solid fa-wrench"></i></span>{% endif %}
                        {% if car.service_status == 'danger' %} <span class="badge bg-danger" title="ТО просрочено!"><i class="fa-solid fa-wrench"></i></span>{% endif %}
                        
                        {% if car.is_truck %}
                            {% if car.ti_status == 'warning' %} <span class="badge bg-warning text-dark" title="Скоро Техосмотр (год)"><i class="fa-solid fa-clipboard-list"></i></span>{% endif %}
                            {% if car.ti_status == 'danger' %} <span class="badge bg-danger" title="Техосмотр просрочен!"><i class="fa-solid fa-clipboard-list"></i></span>{% endif %}
                        {% endif %}

                        {% if car.insurance_expiry and car.insurance_expiry <= warning_date %}
                            <span class="badge bg-danger" title="Истекает страховка!"><i class="fa-solid fa-file-contract"></i></span>
                        {% endif %}
                    </div>
                </div>
                {% if car.current_driver %}
                    <div class="mt-1 small text-warning"><i class="fa-solid fa-user-nurse"></i> {{ car.current_driver.get_full_name|default:car.current_driver.username }}</div>
                {% elif car.status == 'MAINTENANCE' %}
                    <div class="mt-1 small text-body-secondary"><i class="fa-solid fa-wrench"></i> Техническое обслуживание</div>
                {% endif %}
            </a>
            {% empty %}
            <div class="text-center text-body-secondary py-4">Нет автомобилей</div>
            {% endfor %}
        </div>
    </div>

    <div class="col-md-8 p-4 bg-body-tertiary" id="carContent">
        {% include 'inventory/cars_content.html' %}
    </div>
</div>

{% if user.is_staff %}
<div class="modal fade" id="createCarModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><form method="post" action="{% url 'car_create' %}">{% csrf_token %}<div class="modal-header"><h5 class="modal-title">Новый автомобиль</h5></div><div class="modal-body"><div class="mb-3"><label class="fw-bold">Марка/Модель</label>{{ form.name }}</div><div class="mb-3"><label class="fw-bold">Госномер</label>{{ form.license_plate }}</div><div class="mb-3"><label class="fw-bold">Топливо</label>{{ form.fuel_type }}</div><div class="mb-3"><label class="fw-bold">Это грузовой?</label> {{ form.is_truck }}</div><div class="mb-3"><label class="fw-bold">Начальный пробег</label>{{ form.current_mileage }}</div><div class="mb-3"><label class="fw-bold">Посл. ТО (км)</label>{{ form.last_service_mileage }}</div><div class="mb-3"><label class="fw-bold">Посл. Техосмотр</label>{{ form.last_ti_date }}</div><div class="mb-3"><label class="fw-bold">Страховка до</label>{{ form.insurance_expiry }}</div><div class="mb-3"><label class="fw-bold">Чек-лист</label>{{ form.checklist }}</div><div class="mb-3"><label>Описание</label>{{ form.description }}</div></div><div class="modal-footer"><button class="btn btn-success">Создать</button></div></form></div></div></div>
{% endif %}

<script>
    const contentDiv = document.getElementById('carContent');
    const sidebarDiv = document.getElementById('carSidebar');

    function reinitScripts() {
        const fuelCheck=document.getElementById('fuelCheck'),fuelBlock=document.getElementById('fuelInputBlock');
        if(fuelCheck)fuelCheck.addEventListener('change',function(){fuelBlock.style.display=this.checked?'block':'none'});
        
        const fuelTI = document.getElementById('fuelTI'); const fuelTIBlock = document.getElementById('fuelTIBlock');
        if(fuelTI){ fuelTI.addEventListener('change', function() { fuelTIBlock.style.display = this.checked ? 'block' : 'none'; }); }
        
        const fuelFIX = document.getElementById('fuelFIX'); const fuelFIXBlock = document.getElementById('fuelFIXBlock');
        if(fuelFIX){ fuelFIX.addEventListener('change', function() { fuelFIXBlock.style.display = this.checked ? 'block' : 'none'; }); }
    }

    // Функция загрузки данных (универсальная)
    function loadCarData(url) {
        contentDiv.style.opacity = '0.5';
        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(response => response.text())
        .then(html => {
            contentDiv.innerHTML = html;
            contentDiv.style.opacity = '1';
            // Обновляем URL в браузере
            history.pushState(null, '', url);
            reinitScripts();
        });
    }

    // 1. Перехват кликов по пагинации (внутри контента)
    contentDiv.addEventListener('click', function(e) {
        const link = e.target.closest('.ajax-link');
        if (link) {
            e.preventDefault();
            loadCarData(link.href);
        }
    });

    // 2. Перехват кликов по списку машин (СЛЕВА)
    sidebarDiv.addEventListener('click', function(e) {
        // Ищем ссылку, по которой кликнули (или родителя, если кликнули по иконке внутри)
        const link = e.target.closest('a.list-group-item');
        
        if (link) {
            e.preventDefault();
            
            // Визуальное переключение активного класса
            sidebarDiv.querySelectorAll('a').forEach(a => a.classList.remove('active'));
            link.classList.add('active');
            
            // Загрузка данных
            loadCarData(link.href);
            
            // На мобильных: прокрутка к контенту
            if (window.innerWidth < 768) {
                contentDiv.scrollIntoView({ behavior: 'smooth' });
            }
        }
    });
    
    reinitScripts();
</script>

{% endblock %}