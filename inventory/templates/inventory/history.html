{% extends 'inventory/base.html' %}

{% block content %}

<h3 class="mt-2 mb-3">üï∞Ô∏è –ò—Å—Ç–æ—Ä–∏—è –¥–≤–∏–∂–µ–Ω–∏–π</h3>

<div class="filter-box">
    <form method="GET" id="filterForm" class="row g-2 align-items-end">
        <div class="col-md-3">
            <label class="form-label small text-body-secondary mb-1">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç / S/N</label>
            <input type="text" name="search" class="form-control form-control-sm" value="{{ request.GET.search }}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –ò–Ω–≤.‚Ññ">
        </div>

        <div class="col-md-3">
            <label class="form-label small text-body-secondary mb-1">–£—á–∞—Å—Ç–Ω–∏–∫ (–°–æ—Ç—Ä—É–¥–Ω–∏–∫)</label>
            <select name="employee" class="form-select form-select-sm">
                <option value="">- –í—Å–µ -</option>
                {% for emp in employees %}
                    <option value="{{ emp.id }}" {% if request.GET.employee == emp.id|stringformat:"s" %}selected{% endif %}>
                        {{ emp.get_full_name|default:emp.username }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-2">
            <label class="form-label small text-body-secondary mb-1">–î–∞—Ç–∞ –æ—Ç</label>
            <input type="date" name="date_from" class="form-control form-control-sm" value="{{ request.GET.date_from }}">
        </div>

        <div class="col-md-2">
            <label class="form-label small text-body-secondary mb-1">–î–∞—Ç–∞ –¥–æ</label>
            <input type="date" name="date_to" class="form-control form-control-sm" value="{{ request.GET.date_to }}">
        </div>

        <div class="col-md-2">
            <button type="submit" class="btn btn-primary btn-sm w-100">–ü–æ–∫–∞–∑–∞—Ç—å</button>
        </div>
    </form>
</div>

<div id="historyContainer">
    {% include 'inventory/history_content.html' %}
</div>

<script>
    const container = document.getElementById('historyContainer');
    const filterForm = document.getElementById('filterForm');

    function loadData(url) {
        container.style.opacity = '0.5';
        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(response => response.text())
        .then(html => {
            container.innerHTML = html;
            container.style.opacity = '1';
            history.pushState(null, '', url);
        })
        .catch(err => { console.error(err); container.style.opacity = '1'; });
    }

    container.addEventListener('click', function(e) {
        const link = e.target.closest('.ajax-link');
        if (link) {
            e.preventDefault();
            loadData(link.href);
        }
    });

    filterForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(filterForm);
        const queryString = new URLSearchParams(formData).toString();
        loadData(`${window.location.pathname}?${queryString}`);
    });
</script>

{% endblock %}