{% extends 'inventory/base.html' %}

{% block content %}
<div class="row h-100">
    <div class="col-md-4 border-end bg-body p-3" style="min-height: 85vh;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">üìÇ –ö–æ–º–ø–ª–µ–∫—Ç—ã</h5>
            {% if user.is_staff %}
            <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#createKitModal">
                <i class="fa-solid fa-plus"></i> –°–æ–∑–¥–∞—Ç—å
            </button>
            {% endif %}
        </div>
        
        <div class="list-group" id="kitSidebar">
            {% for kit in kits %}
            <a href="?kit_id={{ kit.id }}" class="list-group-item list-group-item-action {% if selected_kit and selected_kit.id == kit.id %}active{% endif %}">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">{{ kit.name }}</h6>
                    <small>
                        {% if kit.status == 'IN_STOCK' %}
                            <span class="badge bg-success">–ù–∞ —Å–∫–ª–∞–¥–µ</span>
                        {% else %}
                            <span class="badge bg-warning text-dark">–í—ã–¥–∞–Ω</span>
                        {% endif %}
                    </small>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-body-secondary">{{ kit.description|truncatechars:20 }}</small>
                    {% if kit.warehouse %}
                        <small class="text-body-secondary"><i class="fa-solid fa-warehouse"></i> {{ kit.warehouse.name }}</small>
                    {% endif %}
                </div>
                {% if kit.current_holder %}
                <div class="mt-1 small text-warning">
                    <i class="fa-solid fa-user"></i> {{ kit.current_holder.get_full_name|default:kit.current_holder.username }}
                </div>
                {% endif %}
            </a>
            {% empty %}
            <div class="text-center text-body-secondary py-4">–ù–µ—Ç –∫–æ–º–ø–ª–µ–∫—Ç–æ–≤</div>
            {% endfor %}
        </div>
    </div>

    <div class="col-md-8 p-4 bg-body-tertiary" id="kitContent">
        {% include 'inventory/kits_content.html' %}
    </div>
</div>

{% if user.is_staff %}
<div class="modal fade" id="createKitModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><form method="post" action="{% url 'kit_create' %}">{% csrf_token %}<div class="modal-header"><h5 class="modal-title">–ù–æ–≤—ã–π –∫–æ–º–ø–ª–µ–∫—Ç</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label class="fw-bold">–ù–∞–∑–≤–∞–Ω–∏–µ</label>{{ form.name }}</div><div class="mb-3"><label class="fw-bold">–°–∫–ª–∞–¥ –ø—Ä–∏–ø–∏—Å–∫–∏</label>{{ form.warehouse }}</div><div class="mb-3"><label class="fw-bold">–û–ø–∏—Å–∞–Ω–∏–µ</label>{{ form.description }}</div></div><div class="modal-footer"><button class="btn btn-success">–°–æ–∑–¥–∞—Ç—å</button></div></form></div></div></div>
{% endif %}

<script>
    const contentDiv = document.getElementById('kitContent');
    const sidebarDiv = document.getElementById('kitSidebar');

    // –ü–µ—Ä–µ—Ö–≤–∞—Ç –∫–ª–∏–∫–æ–≤ –ø–æ —Å–ø–∏—Å–∫—É –∫–æ–º–ø–ª–µ–∫—Ç–æ–≤
    sidebarDiv.addEventListener('click', function(e) {
        const link = e.target.closest('a.list-group-item');
        if (link) {
            e.preventDefault();
            
            // –í–∏–∑—É–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ active
            sidebarDiv.querySelectorAll('a').forEach(a => a.classList.remove('active'));
            link.classList.add('active');
            
            contentDiv.style.opacity = '0.5';
            
            fetch(link.href, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(response => response.text())
            .then(html => {
                contentDiv.innerHTML = html;
                contentDiv.style.opacity = '1';
                history.pushState(null, '', link.href);
                // –ï—Å–ª–∏ –Ω—É–∂–Ω—ã —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –º–æ–¥–∞–ª–æ–∫ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ - –æ–Ω–∏ —Ç–∞–º –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
            });
            
            // –ú–æ–±–∏–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
            if (window.innerWidth < 768) {
                contentDiv.scrollIntoView({ behavior: 'smooth' });
            }
        }
    });

    // –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è –º–æ–¥–∞–ª–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è (–ø–µ—Ä–µ–¥–∞–µ–º ID)
    // –¢–∞–∫ –∫–∞–∫ —Ñ—É–Ω–∫—Ü–∏–∏ setRemove... –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –∏–∑ HTML (onclick), –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏.
    window.setRemoveToolModal = function(kitId, toolId, name) {
        document.getElementById('removeToolName').innerText = name;
        document.getElementById('removeToolForm').action = "/kits/" + kitId + "/remove_tool/" + toolId + "/";
    };
    window.setRemoveConsModal = function(kitId, balId, name, maxQty) {
        document.getElementById('removeConsName').innerText = name;
        document.getElementById('removeConsMax').innerText = maxQty;
        var i = document.getElementById('removeConsQty'); i.max = maxQty; i.value = 1;
        document.getElementById('removeConsForm').action = "/kits/" + kitId + "/remove_consumable/" + balId + "/";
    };
</script>

{% endblock %}