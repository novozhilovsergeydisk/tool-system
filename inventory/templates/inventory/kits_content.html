{% if selected_kit %}
    <div class="card shadow-sm">
        <div class="card-header bg-body d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                <i class="fa-solid fa-toolbox text-warning"></i> {{ selected_kit.name }}
                {% if user.is_superuser or perms.inventory.change_toolkit %}
                    <button class="btn btn-sm btn-outline-primary ms-2" data-bs-toggle="modal" data-bs-target="#editKitModal" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                        <i class="fa-solid fa-pencil"></i>
                    </button>
                {% endif %}
            </h4>
            
            <div class="d-flex gap-2">
                {% if selected_kit.status == 'IN_STOCK' %}
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#issueKitModal">
                        {% if user.is_superuser or perms.inventory.change_toolkit %}
                            <i class="fa-solid fa-hand-holding"></i> –í—ã–¥–∞—Ç—å
                        {% else %}
                            <i class="fa-solid fa-hand-point-up"></i> –í–∑—è—Ç—å —Å–µ–±–µ
                        {% endif %}
                    </button>
                {% elif selected_kit.status == 'ISSUED' %}
                        {% if user.is_superuser or perms.inventory.change_toolkit or selected_kit.current_holder == user or user in selected_kit.co_workers.all %}
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#returnKitModal">
                            <i class="fa-solid fa-share"></i> –í–µ—Ä–Ω—É—Ç—å
                            </button>
                        {% else %}
                            <button class="btn btn-secondary" disabled><i class="fa-solid fa-lock"></i> –í–∑—è—Ç: {{ selected_kit.current_holder.get_full_name|default:selected_kit.current_holder.username }}</button>
                        {% endif %}
                {% endif %}

                {% if user.is_superuser or perms.inventory.delete_toolkit %}
                <form action="{% url 'kit_delete' selected_kit.id %}" method="post" class="d-inline ms-2" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Ç? –°–∞–º–∏ —Ç–æ–≤–∞—Ä—ã –æ—Å—Ç–∞–Ω—É—Ç—Å—è –Ω–∞ —Å–∫–ª–∞–¥–µ.');">
                    {% csrf_token %}
                    <button class="btn btn-outline-danger btn-sm" title="–£–¥–∞–ª–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Ç"><i class="fa-solid fa-trash"></i></button>
                </form>
                {% endif %}
            </div>
        </div>

        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> <span class="text-body-secondary">{{ selected_kit.description|default:"-" }}</span>
                </div>
                <div class="col-md-6 text-end">
                    <strong>–°–∫–ª–∞–¥ –ø—Ä–∏–ø–∏—Å–∫–∏:</strong> 
                    {% if selected_kit.warehouse %}
                        <span class="badge bg-secondary">{{ selected_kit.warehouse.name }}</span>
                    {% else %}
                        <span class="text-danger">–ù–µ —É–∫–∞–∑–∞–Ω (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ)</span>
                    {% endif %}
                </div>
            </div>
            
            <h6 class="mt-4 border-bottom pb-2">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (–ë–∞–∑–æ–≤—ã–π —Å–æ—Å—Ç–∞–≤):</h6>
            <div class="table-responsive mb-3">
                <table class="table table-sm table-hover align-middle text-nowrap">
                    <thead><tr><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–ê—Ä—Ç–∏–∫—É–ª</th><th>S/N</th><th>–°—Ç–∞—Ç—É—Å</th><th></th></tr></thead>
                    <tbody>
                        {% for tool in selected_kit.tools.all %}
                        <tr>
                            <td>{{ tool.nomenclature.name }}</td>
                            <td class="text-body-secondary font-monospace small">{{ tool.nomenclature.article }}</td>
                            <td><span class="badge bg-secondary font-monospace">{{ tool.inventory_id }}</span></td>
                            <td>
                                {% if tool.status == 'IN_STOCK' %}
                                    <span class="badge bg-success">–ù–∞ –º–µ—Å—Ç–µ</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="fa-solid fa-user"></i> {{ tool.current_holder.get_full_name|default:tool.current_holder.username }}
                                    </span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                {% if selected_kit.status == 'IN_STOCK' %}
                                <button class="btn btn-link text-danger small text-decoration-none p-0" data-bs-toggle="modal" data-bs-target="#removeToolModal" onclick="setRemoveToolModal('{{ selected_kit.id }}', '{{ tool.id }}', '{{ tool.nomenclature.name }}')"><i class="fa-solid fa-minus"></i> –£–±—Ä–∞—Ç—å</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5" class="text-body-secondary text-center small">–ù–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <h6 class="mt-4 border-bottom pb-2">–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏:</h6>
            <div class="table-responsive mb-3">
                <table class="table table-sm table-hover align-middle text-nowrap">
                    <thead><tr><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–ê—Ä—Ç–∏–∫—É–ª</th><th>–ö–æ–ª-–≤–æ</th><th></th></tr></thead>
                    <tbody>
                        {% for cons in selected_kit.consumables.all %}
                        <tr>
                            <td>{{ cons.nomenclature.name }}</td>
                            <td class="text-body-secondary font-monospace small">{{ cons.nomenclature.article }}</td>
                            <td><span class="badge bg-info text-dark">{{ cons.quantity }} —à—Ç.</span></td>
                            <td class="text-end">
                                {% if selected_kit.status == 'IN_STOCK' %}
                                <button class="btn btn-link text-danger small text-decoration-none p-0" data-bs-toggle="modal" data-bs-target="#removeConsModal" onclick="setRemoveConsModal('{{ selected_kit.id }}', '{{ cons.id }}', '{{ cons.nomenclature.name }}', {{ cons.quantity }})"><i class="fa-solid fa-minus"></i> –£–±—Ä–∞—Ç—å</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4" class="text-body-secondary text-center small">–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if selected_kit.status == 'IN_STOCK' and selected_kit.warehouse %}
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="p-3 bg-body border rounded h-100">
                        <label class="small fw-bold mb-2"><i class="fa-solid fa-hammer"></i> –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç:</label>
                        <input type="text" class="form-control form-control-sm mb-2" placeholder="üîç –ü–æ–∏—Å–∫..." onkeyup="filterOptions(this, 'toolSelect')">
                        <form action="{% url 'kit_add_tool' selected_kit.id %}" method="post" class="d-flex gap-1">
                            {% csrf_token %}
                            <select name="tool_id" id="toolSelect" class="form-select form-select-sm" size="5" required>
                                {% for t in available_tools %}
                                    <option value="{{ t.id }}">
                                        {{ t.nomenclature.name }} {{ t.nomenclature.article }} ‚Ññ{{ t.inventory_id }}
                                    </option>
                                {% endfor %}
                            </select>
                            <button class="btn btn-sm btn-primary align-self-start"><i class="fa-solid fa-plus"></i></button>
                        </form>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="p-3 bg-body border rounded h-100">
                        <label class="small fw-bold mb-2"><i class="fa-solid fa-box"></i> –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫:</label>
                        <input type="text" class="form-control form-control-sm mb-2" placeholder="üîç –ü–æ–∏—Å–∫..." onkeyup="filterOptions(this, 'consSelect')">
                        <form action="{% url 'kit_add_consumable' selected_kit.id %}" method="post">
                            {% csrf_token %}
                            <div class="d-flex gap-1 mb-1">
                                <select name="balance_id" id="consSelect" class="form-select form-select-sm" size="3" required>
                                    {% for c in available_consumables %}
                                        <option value="{{ c.id }}">
                                            {{ c.nomenclature.name }} {{ c.nomenclature.article }} [{{ c.quantity }} —à—Ç]
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="d-flex gap-1">
                                <input type="number" name="quantity" class="form-control form-control-sm" placeholder="–ö–æ–ª-–≤–æ" min="1" required>
                                <button class="btn btn-sm btn-primary w-100"><i class="fa-solid fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    {% if user.is_superuser or perms.inventory.change_toolkit %}
        <div class="modal fade" id="editKitModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><form method="post" action="{% url 'kit_edit' selected_kit.id %}">{% csrf_token %}<div class="modal-header bg-primary text-white"><h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h5></div><div class="modal-body"><div class="mb-3"><label class="fw-bold">–ù–∞–∑–≤–∞–Ω–∏–µ</label>{{ edit_form.name }}</div><div class="mb-3"><label class="fw-bold">–°–∫–ª–∞–¥ –ø—Ä–∏–ø–∏—Å–∫–∏</label>{{ edit_form.warehouse }}</div><div class="mb-3"><label class="fw-bold">–û–ø–∏—Å–∞–Ω–∏–µ</label>{{ edit_form.description }}</div></div><div class="modal-footer"><button class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div></form></div></div></div>
    {% endif %}

    <div class="modal fade" id="removeToolModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><form method="post" id="removeToolForm" action="">{% csrf_token %}<div class="modal-header bg-danger text-white"><h5 class="modal-title">–£–±—Ä–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</h5></div><div class="modal-body"><p>–£–±–∏—Ä–∞–µ–º: <strong id="removeToolName"></strong></p><div class="alert alert-info small">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –Ω–∞ —Å–∫–ª–∞–¥–µ, –Ω–æ –æ—Ç–≤—è–∂–µ—Ç—Å—è –æ—Ç –∫–æ–º–ø–ª–µ–∫—Ç–∞.</div></div><div class="modal-footer"><button class="btn btn-danger">–£–±—Ä–∞—Ç—å</button></div></form></div></div></div>
    <div class="modal fade" id="removeConsModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><form method="post" id="removeConsForm" action="">{% csrf_token %}<div class="modal-header bg-danger text-white"><h5 class="modal-title">–£–±—Ä–∞—Ç—å —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫</h5></div><div class="modal-body"><p>–£–±–∏—Ä–∞–µ–º: <strong id="removeConsName"></strong></p><div class="mb-3"><label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label><input type="number" name="quantity" id="removeConsQty" class="form-control" min="1" required></div></div><div class="modal-footer"><button class="btn btn-danger">–£–±—Ä–∞—Ç—å</button></div></form></div></div></div>

    <div class="modal fade" id="issueKitModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><form method="post" action="{% url 'kit_issue' selected_kit.id %}">{% csrf_token %}<div class="modal-header bg-primary text-white"><h5 class="modal-title">–í—ã–¥–∞—á–∞ –∫–æ–º–ø–ª–µ–∫—Ç–∞</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <div class="mb-3">
                <label class="fw-bold small">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π (–ü–æ–ª—É—á–∞—Ç–µ–ª—å):</label>
                
                {% if user.is_superuser or perms.inventory.change_toolkit %}
                    <select name="employee_id" class="form-select mb-3">{% for emp in employees %}<option value="{{ emp.id }}">{{ emp.get_full_name|default:emp.username }}</option>{% endfor %}</select>
                {% else %}
                    <input type="hidden" name="employee_id" value="{{ user.id }}">
                    <div class="alert alert-light border py-2"><i class="fa-solid fa-user-check"></i> {{ user.get_full_name|default:user.username }}</div>
                {% endif %}
            </div>

            <div class="mb-3">
                <label class="fw-bold small text-body-secondary">–ö—Ç–æ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∫–æ–º–ø–ª–µ–∫—Ç–æ–º (—Å–º–æ–≥—É—Ç –≤–µ—Ä–Ω—É—Ç—å):</label>
                <div class="border rounded p-2 bg-body" style="max-height: 120px; overflow-y: auto;">
                    {% for emp in employees %}
                        {% if emp.id != user.id %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="partner_ids" value="{{ emp.id }}" id="partner{{ emp.id }}">
                                <label class="form-check-label small" for="partner{{ emp.id }}">
                                    {{ emp.get_full_name|default:emp.username }}
                                </label>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-end border-bottom pb-1 mt-4">
                <h6 class="mb-0">–ß—Ç–æ –±–µ—Ä–µ—Ç–µ? (–°–Ω–∏–º–∏—Ç–µ –ª–∏—à–Ω–µ–µ)</h6>
                <div>
                    <a href="#" onclick="toggleAll(true); return false;" class="small text-decoration-none fw-bold">–≤—ã–¥–µ–ª–∏—Ç—å –≤—Å–µ</a>
                    <span class="text-muted small">/</span>
                    <a href="#" onclick="toggleAll(false); return false;" class="small text-decoration-none text-danger">—Å–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ</a>
                </div>
            </div>

            <div style="max-height: 200px; overflow-y: auto;">
                {% for tool in selected_kit.tools.all %}
                    {% if tool.status == 'IN_STOCK' %}
                        <div class="form-check mt-1">
                            <input class="form-check-input" type="checkbox" name="tools_selected" value="{{ tool.id }}" id="t{{ tool.id }}" checked>
                            <label class="form-check-label small" for="t{{ tool.id }}">
                                {{ tool.nomenclature.name }} ({{ tool.inventory_id }})
                            </label>
                        </div>
                    {% else %}
                         <div class="text-body-secondary small mt-1 ms-4 opacity-75">
                            <i class="fa-solid fa-ban text-danger"></i> {{ tool.nomenclature.name }} (–£–∂–µ —É: {{ tool.current_holder.get_full_name|default:tool.current_holder.username }})
                         </div>
                    {% endif %}
                {% endfor %}
                
                {% for cons in selected_kit.consumables.all %}
                <div class="form-check mt-1">
                    <input class="form-check-input" type="checkbox" name="cons_selected" value="{{ cons.id }}" id="c{{ cons.id }}" checked>
                    <label class="form-check-label small" for="c{{ cons.id }}">
                        {{ cons.nomenclature.name }} {{ cons.nomenclature.article }} ({{ cons.quantity }} —à—Ç)
                    </label>
                </div>
                {% endfor %}
            </div>
            
            <div class="mt-3">
                <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
                <textarea name="comment" class="form-control" rows="2"></textarea>
            </div>
        </div>
        <div class="modal-footer"><button class="btn btn-primary">–í—ã–¥–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ</button></div>
    </form></div></div></div>
    
    <div class="modal fade" id="returnKitModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><form method="post" action="{% url 'kit_return' selected_kit.id %}">{% csrf_token %}<div class="modal-header bg-success text-white"><h5 class="modal-title">–í–æ–∑–≤—Ä–∞—Ç –∫–æ–º–ø–ª–µ–∫—Ç–∞</h5></div>
        <div class="modal-body">
            <div class="alert alert-warning small mb-2">
                <i class="fa-solid fa-info-circle"></i> 
                <b>–í–Ω–∏–º–∞–Ω–∏–µ:</b> –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤–µ—Ä–Ω—É—Ç—Å—è –Ω–∞ —Å–∫–ª–∞–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –∑–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º.
            </div>

            <p class="mb-1 fw-bold text-success"><i class="fa-solid fa-arrow-rotate-left"></i> –í–µ—Ä–Ω–µ—Ç—Å—è –Ω–∞ —Å–∫–ª–∞–¥:</p>
                <div class="border rounded p-2 bg-body mb-3" style="max-height: 200px; overflow-y: auto;">
                        <ul class="list-unstyled mb-0 small">
                            
                            {% for tool in selected_kit.tools.all %}
                                {% if tool.current_holder == selected_kit.current_holder and not tool.is_manual_issue %}
                                    <li class="d-flex justify-content-between border-bottom py-1">
                                        <span>
                                            <i class="fa-solid fa-hammer text-secondary"></i> 
                                            <strong>{{ tool.nomenclature.name }}</strong>
                                            <span class="text-body-secondary">{{ tool.nomenclature.article }}</span>
                                        </span>
                                        <span class="font-monospace text-body-secondary">{{ tool.inventory_id }}</span>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% for cons in selected_kit.consumables.all %}
                                {% if cons.holder == selected_kit.current_holder %}
                                    <li class="d-flex justify-content-between border-bottom py-1 bg-body-tertiary">
                                        <span>
                                            <i class="fa-solid fa-box text-info"></i> 
                                            <strong>{{ cons.nomenclature.name }}</strong>
                                            <span class="text-body-secondary">{{ cons.nomenclature.article }}</span>
                                        </span>
                                        <span class="badge bg-info text-dark">{{ cons.quantity }} —à—Ç</span>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            
                        </ul>
                    </div>

            <div class="alert alert-danger small py-2 fw-bold text-center">
                <i class="fa-solid fa-triangle-exclamation"></i> 
                –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–º–ø–ª–µ–∫—Ç –ø–µ—Ä–µ–¥ –≤–æ–∑–≤—Ä–∞—Ç–æ–º!
            </div>

            <div class="mb-3">
                <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
                <textarea name="comment" class="form-control" rows="2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í—Å—ë –∏—Å–ø—Ä–∞–≤–Ω–æ"></textarea>
            </div>
        </div>
        <div class="modal-footer"><button class="btn btn-success">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç</button></div>
    </form></div></div></div>

    <script>
        function setRemoveToolModal(kitId, toolId, name) {
            document.getElementById('removeToolName').innerText = name;
            document.getElementById('removeToolForm').action = "/kits/" + kitId + "/remove_tool/" + toolId + "/";
        }
        function setRemoveConsModal(kitId, balId, name, maxQty) {
            document.getElementById('removeConsName').innerText = name;
            document.getElementById('removeConsMax').innerText = maxQty;
            var i = document.getElementById('removeConsQty'); i.max = maxQty; i.value = 1;
            document.getElementById('removeConsForm').action = "/kits/" + kitId + "/remove_consumable/" + balId + "/";
        }
        function filterOptions(input, selectId) {
            const filter = input.value.toLowerCase();
            const select = document.getElementById(selectId);
            const options = select.getElementsByTagName('option');
            for (let i = 0; i < options.length; i++) {
                const txt = options[i].text.toLowerCase();
                options[i].style.display = txt.includes(filter) ? "" : "none";
            }
        }
        
        window.toggleAll = function(state) {
            const modal = document.getElementById('issueKitModal');
            if (!modal) return;
            const checkboxes = modal.querySelectorAll('input[name="tools_selected"], input[name="cons_selected"]');
            checkboxes.forEach(cb => cb.checked = state);
        };
    </script>
{% endif %}