{% extends 'inventory/base.html' %}

{% block content %}
<div class="row justify-content-center mt-4">
    <div class="col-md-6">
        <div class="card shadow-lg border-0">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fa-solid fa-plus-circle"></i> Приход на склад</h5>
            </div>
            <div class="card-body">
                <form method="post" id="addForm">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label class="form-label fw-bold">Что принимаем?</label>
                        
                        <input class="form-control" list="datalistOptions" id="nomSearchInput" placeholder="Начните вводить название или артикул..." autocomplete="off" oninput="onSearchInput()">
                        
                        <datalist id="datalistOptions">
                            {% for item in nomenclatures %}
                                <option data-id="{{ item.id }}" value="{{ item.name }} ({{ item.article }})"></option>
                            {% endfor %}
                        </datalist>

                        <input type="hidden" name="nomenclature_id" id="hiddenNomId" required>

                        <div class="form-text text-end">
                            <a href="{% url 'nomenclature_list' %}" class="text-decoration-none" target="_blank">
                                <i class="fa-solid fa-list"></i> Нет в списке? Создать
                            </a>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">На какой склад?</label>
                        <select name="warehouse_id" class="form-select" required>
                            {% for wh in warehouses %}
                                <option value="{{ wh.id }}">{{ wh.name }}</option>
                            {% empty %}
                                <option disabled>Нет доступных складов</option>
                            {% endfor %}
                        </select>
                        {% if not user.is_superuser %}
                            <div class="form-text text-success">
                                <i class="fa-solid fa-shield-halved"></i> Только доступные вам склады.
                            </div>
                        {% endif %}
                    </div>

                    <div id="block-sn" style="display: none;">
                        <div class="mb-3 p-3 border rounded">
                            <label class="form-label fw-bold">Инвентарный номер / S/N</label>
                            <input type="text" name="inventory_id" id="input-sn" class="form-control" placeholder="Например: 100500" autocomplete="off">
                            <div class="form-text">Уникальный номер для отслеживания инструмента.</div>
                        </div>
                    </div>

                    <div id="block-condition" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Состояние</label>
                            <select name="condition" class="form-select">
                                <option value="NEW" selected>Новое</option>
                                <option value="USED">Б/У (Рабочее)</option>
                                <option value="BROKEN">Сломано (На ремонт)</option>
                            </select>
                        </div>
                    </div>

                    <div id="block-qty" style="display: none;">
                        <div class="p-3 rounded border mb-3 bg-warning-subtle border-warning">
                            <label class="form-label fw-bold">Количество</label>
                            <input type="number" name="quantity" id="input-qty" class="form-control" placeholder="Сколько штук?" min="1">
                            <div class="form-text">Будет добавлено к текущему остатку на складе.</div>
                        </div>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'tool_list' %}" class="btn btn-secondary">Отмена</a>
                        <button type="submit" class="btn btn-success fw-bold px-4" id="submitBtn" disabled>Принять на баланс</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Словарь типов: {id: 'TOOL', ...}
    const typesMap = {{ types_json|safe }}; 
    
    function onSearchInput() {
        const input = document.getElementById('nomSearchInput');
        const hiddenId = document.getElementById('hiddenNomId');
        const datalist = document.getElementById('datalistOptions');
        const submitBtn = document.getElementById('submitBtn');
        
        const val = input.value;
        let foundId = "";

        // Ищем ID по введенному тексту
        const options = datalist.options;
        for (let i = 0; i < options.length; i++) {
            if (options[i].value === val) {
                foundId = options[i].getAttribute('data-id');
                break;
            }
        }

        hiddenId.value = foundId;

        if (foundId) {
            submitBtn.removeAttribute('disabled');
            toggleFields(foundId);
        } else {
            submitBtn.setAttribute('disabled', 'true');
            hideAllBlocks();
        }
    }

    function toggleFields(id) {
        const type = typesMap[id];

        const blockSn = document.getElementById('block-sn');
        const blockCond = document.getElementById('block-condition');
        const blockQty = document.getElementById('block-qty');
        
        const inputSn = document.getElementById('input-sn');
        const inputQty = document.getElementById('input-qty');

        // Сброс required
        inputSn.removeAttribute('required');
        inputQty.removeAttribute('required');

        if (type === 'CONSUMABLE') {
            // РАСХОДНИК
            blockSn.style.display = 'none';
            blockCond.style.display = 'none';
            blockQty.style.display = 'block';
            inputQty.setAttribute('required', 'true');
        } 
        else if (type === 'EQUIPMENT') {
            // ЭКИПИРОВКА (Только состояние)
            blockSn.style.display = 'none';
            blockCond.style.display = 'block';
            blockQty.style.display = 'none';
        } 
        else {
            // ИНСТРУМЕНТ (S/N + Состояние)
            blockSn.style.display = 'block';
            blockCond.style.display = 'block';
            blockQty.style.display = 'none';
            inputSn.setAttribute('required', 'true');
        }
    }

    function hideAllBlocks() {
        document.getElementById('block-sn').style.display = 'none';
        document.getElementById('block-condition').style.display = 'none';
        document.getElementById('block-qty').style.display = 'none';
    }
</script>
{% endblock %}