{% extends 'inventory/base.html' %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3 mt-2 flex-wrap gap-2">
    <h3 style="margin:0;">üì¶ –¢–æ–≤–∞—Ä—ã</h3>
    
    {% if user.is_staff %}
    <div class="d-flex gap-2">
        <a href="{% url 'nomenclature_list' %}" class="btn btn-primary btn-sm shadow-sm">
            <i class="fa-solid fa-book"></i> –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã
        </a>
        <a href="{% url 'print_barcodes' %}" class="btn btn-info btn-sm shadow-sm text-white">
            <i class="fa-solid fa-print"></i> –ü–µ—á–∞—Ç—å
        </a>
        <a href="{% url 'tool_add' %}" class="btn btn-success btn-sm shadow-sm fw-bold">
            <i class="fa-solid fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
        </a>
    </div>
    {% endif %}
</div>

<div class="filter-box">
    <span class="filter-title">–§–∏–ª—å—Ç—Ä—ã</span>
    <form method="GET" class="row g-2 align-items-end">
        <div class="col-md-4">
            <label class="form-label small text-body-secondary">–ü–æ–∏—Å–∫</label>
            <input type="text" name="search" class="form-control form-control-sm" value="{{ request.GET.search }}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ / –ò–Ω–≤.‚Ññ">
        </div>
        
        <div class="col-md-3">
            <label class="form-label small text-body-secondary">–°–∫–ª–∞–¥</label>
            <select name="warehouse" id="filterWarehouse" class="form-select form-select-sm">
                <option value="">- –í—Å–µ —Å–∫–ª–∞–¥—ã -</option>
                {% for wh in warehouses %}
                    <option value="{{ wh.id }}" {% if request.GET.warehouse == wh.id|stringformat:"s" %}selected{% endif %}>üè† {{ wh.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="col-md-3">
            <label class="form-label small text-body-secondary">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
            <select name="employee" id="filterEmployee" class="form-select form-select-sm">
                <option value="">- –í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ -</option>
                {% for emp in employees %}
                    <option value="{{ emp.id }}" {% if request.GET.employee == emp.id|stringformat:"s" %}selected{% endif %}>üë§ {{ emp.get_full_name|default:emp.username }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="col-md-2 d-flex gap-1">
            <button type="submit" class="btn btn-primary btn-sm flex-grow-1">–ù–∞–π—Ç–∏</button>
            <a href="{% url 'tool_list' %}" class="btn btn-secondary btn-sm">X</a>
        </div>
    </form>
</div>

<h5 class="mt-4 mb-2 text-body-secondary"><i class="fa-solid fa-hammer"></i> –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h5>
<div class="card shadow-sm mb-4">
    <div class="card-body p-0 bg-body table-responsive">
        <table class="table table-striped table-hover table-custom mb-0 align-middle">
            <thead>
                <tr>
                    <th style="width: 50px;">ID</th>
                    <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                    <th>–ê—Ä—Ç–∏–∫—É–ª</th>
                    <th>–ò–Ω–≤. ‚Ññ</th>
                    <th>–í–ª–∞–¥–µ–ª–µ—Ü</th>
                    <th>–°–æ—Å—Ç–æ—è–Ω–∏–µ</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    {% if user.is_staff %} <th style="min-width: 150px; text-align: center;">–î–µ–π—Å—Ç–≤–∏—è</th> {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for tool in tools %}
                <tr>
                    <td>{{ tool.id }}</td>
                    <td><strong>{{ tool.nomenclature.name }}</strong></td>
                    <td class="text-body-secondary font-monospace small">{{ tool.nomenclature.article }}</td>
                    <td><span class="badge bg-secondary font-monospace fs-6">{{ tool.inventory_id }}</span></td>
                    <td>
                        {% if tool.current_holder %} 
                            <span class="text-primary small text-nowrap"><i class="fa-solid fa-user"></i> {{ tool.current_holder.get_full_name|default:tool.current_holder.username }}</span>
                        {% elif tool.current_warehouse %} 
                            <span class="text-body-secondary small text-nowrap"><i class="fa-solid fa-warehouse"></i> {{ tool.current_warehouse.name }}</span>
                        {% else %} 
                            <span class="text-danger small">? –ü–æ—Ç–µ—Ä—è–Ω–æ</span> 
                        {% endif %}
                    </td>
                    <td>
                        {% if tool.condition == 'NEW' %}<span class="badge rounded-pill text-bg-info text-white">–ù–æ–≤–æ–µ</span>
                        {% elif tool.condition == 'USED' %}<span class="badge rounded-pill bg-body-tertiary text-dark border">–ë/–£</span>
                        {% elif tool.condition == 'BROKEN' %}<span class="badge rounded-pill bg-danger">–°–ª–æ–º–∞–Ω–æ</span>
                        {% else %}{{ tool.get_condition_display }}{% endif %}
                    </td>
                    <td>
                        {% if tool.status == 'IN_STOCK' %}<span class="badge bg-success">–ù–∞ —Å–∫–ª–∞–¥–µ</span>
                        {% elif tool.status == 'ISSUED' %}<span class="badge bg-warning text-dark">–í—ã–¥–∞–Ω–æ</span>
                        {% elif tool.status == 'BROKEN' %}<span class="badge bg-danger">–í —Ä–µ–º–æ–Ω—Ç–µ</span>
                        {% else %}<span class="badge bg-secondary">{{ tool.get_status_display }}</span>{% endif %}
                    </td>
                    {% if user.is_staff %}
                    <td align="center">
                        <div class="d-flex justify-content-center gap-1">
                            {% if tool.status == 'IN_STOCK' %}
                                <button class="btn btn-sm btn-warning text-dark" title="–í—ã–¥–∞—Ç—å" data-bs-toggle="modal" data-bs-target="#issueModal" onclick="setIssueModal('{{ tool.id }}', '{{ tool.nomenclature.name }}')"><i class="fa-solid fa-hand-holding"></i></button>
                            {% elif tool.status == 'ISSUED' %}
                                <button class="btn btn-sm btn-success" title="–í–µ—Ä–Ω—É—Ç—å" data-bs-toggle="modal" data-bs-target="#returnModal" onclick="setReturnModal('{{ tool.id }}', '{{ tool.nomenclature.name }}')"><i class="fa-solid fa-share"></i></button>
                            {% endif %}
                            
                            <a href="{% url 'tool_edit' tool.id %}" class="btn btn-outline-secondary btn-sm" title="–†–µ–¥."><i class="fa-solid fa-pencil"></i></a>
                            
                            <button class="btn btn-sm btn-danger" title="–°–ø–∏—Å–∞—Ç—å" data-bs-toggle="modal" data-bs-target="#toolWriteoffModal" onclick="setToolWriteoffModal('{{ tool.id }}', '{{ tool.nomenclature.name }}', '{{ tool.inventory_id }}')"><i class="fa-solid fa-fire"></i></button>
                        </div>
                    </td>
                    {% endif %}
                </tr>
                {% empty %}
                <tr><td colspan="8" class="text-center py-3 text-body-secondary">–ù–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if tools.has_other_pages %}
    <div class="card-footer bg-body-tertiary py-2">
        <nav>
            <ul class="pagination pagination-sm justify-content-center mb-0">
                {% if tools.has_previous %}
                    <li class="page-item"><a class="page-link" href="?page_tools={{ tools.previous_page_number }}&page_cons={{ consumables.number }}&search={{ request.GET.search }}&warehouse={{ request.GET.warehouse }}&employee={{ request.GET.employee }}"><i class="fa-solid fa-chevron-left"></i></a></li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link"><i class="fa-solid fa-chevron-left"></i></span></li>
                {% endif %}

                <li class="page-item disabled"><span class="page-link text-dark">–°—Ç—Ä. {{ tools.number }} –∏–∑ {{ tools.paginator.num_pages }}</span></li>

                {% if tools.has_next %}
                    <li class="page-item"><a class="page-link" href="?page_tools={{ tools.next_page_number }}&page_cons={{ consumables.number }}&search={{ request.GET.search }}&warehouse={{ request.GET.warehouse }}&employee={{ request.GET.employee }}"><i class="fa-solid fa-chevron-right"></i></a></li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link"><i class="fa-solid fa-chevron-right"></i></span></li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<h5 class="mt-4 mb-2 text-body-secondary"><i class="fa-solid fa-boxes-stacked"></i> –†–∞—Å—Ö–æ–¥–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h5>
<div class="card shadow-sm">
    <div class="card-body p-0 bg-body table-responsive">
        <table class="table table-striped table-hover table-custom mb-0 align-middle">
            <thead>
                <tr>
                    <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                    <th>–ê—Ä—Ç–∏–∫—É–ª</th>
                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                    <th>–í–ª–∞–¥–µ–ª–µ—Ü</th>
                    {% if user.is_staff %} <th style="min-width: 150px; text-align: center;">–î–µ–π—Å—Ç–≤–∏—è</th> {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for item in consumables %}
                <tr>
                    <td><strong>{{ item.nomenclature.name }}</strong></td>
                    <td class="text-body-secondary font-monospace small">{{ item.nomenclature.article }}</td>
                    <td><span class="badge bg-primary fs-6">{{ item.quantity }}</span></td>
                    <td class="small">
                        {% if item.holder %}
                            <span class="text-primary text-nowrap"><i class="fa-solid fa-user"></i> {{ item.holder.get_full_name|default:item.holder.username }}</span>
                        {% elif item.warehouse %}
                            <span class="text-secondary text-nowrap"><i class="fa-solid fa-warehouse"></i> {{ item.warehouse.name }}</span>
                        {% endif %}
                    </td>
                    
                    {% if user.is_staff %}
                    <td align="center">
                        <div class="d-flex justify-content-center gap-1">
                            {% if item.warehouse and item.quantity > 0 %}
                                <button class="btn btn-sm btn-warning text-dark" title="–í—ã–¥–∞—Ç—å" data-bs-toggle="modal" data-bs-target="#consumableIssueModal" onclick="setConsumableIssueModal('{{ item.id }}', '{{ item.nomenclature.name }}', {{ item.quantity }})"><i class="fa-solid fa-hand-holding"></i></button>
                            {% endif %}

                            {% if item.holder and item.quantity > 0 %}
                                <button class="btn btn-sm btn-success" title="–í–µ—Ä–Ω—É—Ç—å" data-bs-toggle="modal" data-bs-target="#consumableReturnModal" onclick="setConsumableReturnModal('{{ item.id }}', '{{ item.nomenclature.name }}', {{ item.quantity }})"><i class="fa-solid fa-share"></i></button>
                            {% endif %}

                            <button class="btn btn-sm btn-danger" title="–°–ø–∏—Å–∞—Ç—å" data-bs-toggle="modal" data-bs-target="#consumableWriteoffModal" onclick="setConsumableWriteoffModal('{{ item.id }}', '{{ item.nomenclature.name }}', {{ item.quantity }})"><i class="fa-solid fa-fire"></i></button>
                        </div>
                    </td>
                    {% endif %}
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-center py-3 text-body-secondary">–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if consumables.has_other_pages %}
    <div class="card-footer bg-body-tertiary py-2">
        <nav>
            <ul class="pagination pagination-sm justify-content-center mb-0">
                {% if consumables.has_previous %}
                    <li class="page-item"><a class="page-link" href="?page_cons={{ consumables.previous_page_number }}&page_tools={{ tools.number }}&search={{ request.GET.search }}&warehouse={{ request.GET.warehouse }}&employee={{ request.GET.employee }}"><i class="fa-solid fa-chevron-left"></i></a></li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link"><i class="fa-solid fa-chevron-left"></i></span></li>
                {% endif %}

                <li class="page-item disabled"><span class="page-link text-dark">–°—Ç—Ä. {{ consumables.number }} –∏–∑ {{ consumables.paginator.num_pages }}</span></li>

                {% if consumables.has_next %}
                    <li class="page-item"><a class="page-link" href="?page_cons={{ consumables.next_page_number }}&page_tools={{ tools.number }}&search={{ request.GET.search }}&warehouse={{ request.GET.warehouse }}&employee={{ request.GET.employee }}"><i class="fa-solid fa-chevron-right"></i></a></li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link"><i class="fa-solid fa-chevron-right"></i></span></li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

{% if user.is_staff %}
<div class="modal fade" id="issueModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form method="post" id="issueForm" action="">{% csrf_token %}<div class="modal-header bg-warning"><h5 class="modal-title">–í—ã–¥–∞—á–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>–í—ã–¥–∞–µ–º: <strong id="issueToolName"></strong></p><label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</label><select name="employee_id" class="form-select" required>{% for emp in employees %}<option value="{{ emp.id }}">{{ emp.get_full_name|default:emp.username }}</option>{% endfor %}</select></div><div class="modal-footer"><button class="btn btn-primary w-100">–í—ã–¥–∞—Ç—å</button></div></form></div></div></div>
<div class="modal fade" id="returnModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form method="post" id="returnForm" action="">{% csrf_token %}<div class="modal-header bg-success text-white"><h5 class="modal-title">–í–æ–∑–≤—Ä–∞—Ç –Ω–∞ —Å–∫–ª–∞–¥</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>–í–æ–∑–≤—Ä–∞—Ç: <strong id="returnToolName"></strong></p><label>–ù–∞ —Å–∫–ª–∞–¥:</label><select name="warehouse_id" class="form-select" required>{% for wh in warehouses %}<option value="{{ wh.id }}">{{ wh.name }}</option>{% endfor %}</select></div><div class="modal-footer"><button class="btn btn-success w-100">–í–µ—Ä–Ω—É—Ç—å</button></div></form></div></div></div>
<div class="modal fade" id="toolWriteoffModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form method="post" id="toolWriteoffForm" action="">{% csrf_token %}<div class="modal-header bg-danger text-white"><h5 class="modal-title">–°–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="alert alert-warning small"><i class="fa-solid fa-triangle-exclamation"></i> –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω –∏–∑ —Å–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤!</div><p>–°–ø–∏—Å–∞—Ç—å: <strong id="toolWriteName"></strong></p><p>–ò–Ω–≤. ‚Ññ: <span id="toolWriteInv" class="font-monospace"></span></p><div class="mb-3"><label>–ü—Ä–∏—á–∏–Ω–∞ —Å–ø–∏—Å–∞–Ω–∏—è:</label><textarea name="reason" class="form-control" rows="3" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –£—Ç–µ—Ä—è–Ω, –°–ª–æ–º–∞–Ω –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ–º–æ–Ω—Ç–∞" required></textarea></div></div><div class="modal-footer"><button class="btn btn-danger w-100">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ</button></div></form></div></div></div>
<div class="modal fade" id="consumableIssueModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form method="post" id="consumableIssueForm" action="">{% csrf_token %}<div class="modal-header bg-warning"><h5 class="modal-title">–í—ã–¥–∞—á–∞ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>–¢–æ–≤–∞—Ä: <strong id="consumableName"></strong></p><p class="text-body-secondary small">–î–æ—Å—Ç—É–ø–Ω–æ: <span id="consumableMax"></span></p><div class="mb-3"><label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label><input type="number" name="quantity" id="consumableQty" class="form-control" min="1" required></div><div class="mb-3"><label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</label><select name="employee_id" class="form-select" required>{% for emp in employees %}<option value="{{ emp.id }}">{{ emp.get_full_name|default:emp.username }}</option>{% endfor %}</select></div></div><div class="modal-footer"><button class="btn btn-primary w-100">–í—ã–¥–∞—Ç—å</button></div></form></div></div></div>
<div class="modal fade" id="consumableReturnModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form method="post" id="consumableReturnForm" action="">{% csrf_token %}<div class="modal-header bg-success text-white"><h5 class="modal-title">–í–æ–∑–≤—Ä–∞—Ç —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>–¢–æ–≤–∞—Ä: <strong id="conRetName"></strong></p><p class="text-body-secondary small">–ù–∞ —Ä—É–∫–∞—Ö: <span id="conRetMax"></span></p><div class="mb-3"><label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label><input type="number" name="quantity" id="conRetQty" class="form-control" min="1" required></div><div class="mb-3"><label>–ù–∞ —Å–∫–ª–∞–¥:</label><select name="warehouse_id" class="form-select" required>{% for wh in warehouses %}<option value="{{ wh.id }}">{{ wh.name }}</option>{% endfor %}</select></div></div><div class="modal-footer"><button class="btn btn-success w-100">–í–µ—Ä–Ω—É—Ç—å</button></div></form></div></div></div>
<div class="modal fade" id="consumableWriteoffModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form method="post" id="consumableWriteoffForm" action="">{% csrf_token %}<div class="modal-header bg-danger text-white"><h5 class="modal-title">–°–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>–°–ø–∏—Å–∞—Ç—å: <strong id="conWriteName"></strong></p><p class="text-body-secondary small">–î–æ—Å—Ç—É–ø–Ω–æ: <span id="conWriteMax"></span></p><div class="mb-3"><label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label><input type="number" name="quantity" id="conWriteQty" class="form-control" min="1" required></div><div class="mb-3"><label>–ü—Ä–∏—á–∏–Ω–∞:</label><input type="text" name="reason" class="form-control" placeholder="–°–ª–æ–º–∞–Ω–æ / –ò–∑—Ä–∞—Å—Ö–æ–¥–æ–≤–∞–Ω–æ" required></div></div><div class="modal-footer"><button class="btn btn-danger w-100">–°–ø–∏—Å–∞—Ç—å</button></div></form></div></div></div>

<script>
    function setIssueModal(id, name) { document.getElementById('issueToolName').innerText = name; document.getElementById('issueForm').action = "/tool/" + id + "/issue/"; }
    function setReturnModal(id, name) { document.getElementById('returnToolName').innerText = name; document.getElementById('returnForm').action = "/tool/" + id + "/return/"; }
    function setToolWriteoffModal(id, name, inv) { document.getElementById('toolWriteName').innerText = name; document.getElementById('toolWriteInv').innerText = inv; document.getElementById('toolWriteoffForm').action = "/tool/" + id + "/writeoff/"; }
    function setConsumableIssueModal(id, name, maxQty) { document.getElementById('consumableName').innerText = name; document.getElementById('consumableMax').innerText = maxQty; var i = document.getElementById('consumableQty'); i.max = maxQty; i.value = 1; document.getElementById('consumableIssueForm').action = "/consumable/" + id + "/issue/"; }
    function setConsumableReturnModal(id, name, maxQty) { document.getElementById('conRetName').innerText = name; document.getElementById('conRetMax').innerText = maxQty; var i = document.getElementById('conRetQty'); i.max = maxQty; i.value = 1; document.getElementById('consumableReturnForm').action = "/consumable/" + id + "/return/"; }
    function setConsumableWriteoffModal(id, name, maxQty) { document.getElementById('conWriteName').innerText = name; document.getElementById('conWriteMax').innerText = maxQty; var i = document.getElementById('conWriteQty'); i.max = maxQty; i.value = 1; document.getElementById('consumableWriteoffForm').action = "/consumable/" + id + "/writeoff/"; }

    const filterWh = document.getElementById('filterWarehouse');
    const filterEmp = document.getElementById('filterEmployee');
    if(filterWh && filterEmp){
        filterWh.addEventListener('change', function() { if (this.value) filterEmp.value = ""; });
        filterEmp.addEventListener('change', function() { if (this.value) filterWh.value = ""; });
    }
</script>
{% endif %}

{% endblock %}