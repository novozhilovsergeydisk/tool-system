{% extends 'inventory/base.html' %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3 mt-2 flex-wrap gap-2">
    <h3 style="margin:0;">üì¶ –¢–æ–≤–∞—Ä—ã</h3>
    
<div class="d-flex gap-2">
        {% if user.is_superuser or perms.inventory.change_nomenclature or perms.inventory.add_nomenclature %}
            <a href="{% url 'nomenclature_list' %}" class="btn btn-primary btn-sm shadow-sm">
                <i class="fa-solid fa-book"></i> –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã
            </a>
        {% endif %}

        {% if user.is_superuser or perms.inventory.view_nomenclature %}
            <a href="{% url 'print_barcodes' %}" class="btn btn-info btn-sm shadow-sm text-white">
                <i class="fa-solid fa-print"></i> –ü–µ—á–∞—Ç—å
            </a>
        {% endif %}

        {% if user.is_superuser or perms.inventory.add_toolinstance %}
            <a href="{% url 'tool_add' %}" class="btn btn-success btn-sm shadow-sm fw-bold">
                <i class="fa-solid fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
            </a>
        {% endif %}
    </div>
</div>

<div class="filter-box">
    <span class="filter-title">–§–∏–ª—å—Ç—Ä—ã</span>
    <form method="GET" id="filterForm" class="row g-2 align-items-end">
        
        <div class="col-md-3">
            <label class="form-label small text-body-secondary">–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ / –∫–æ–º–ø–ª–µ–∫—Ç–∞</label>
            <input type="text" name="search" class="form-control form-control-sm" value="{{ request.GET.search }}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, HILTI, H-1...">
        </div>
        
        <div class="col-md-2">
            <label class="form-label small text-body-secondary">–¢–∏–ø</label>
            <select name="item_type" id="filterType" class="form-select form-select-sm">
                <option value="">- –í—Å–µ -</option>
                <option value="TOOL" {% if request.GET.item_type == 'TOOL' %}selected{% endif %}>üî® –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</option>
                <option value="EQUIPMENT" {% if request.GET.item_type == 'EQUIPMENT' %}selected{% endif %}>ü¶∫ –≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞</option>
                <option value="CONSUMABLE" {% if request.GET.item_type == 'CONSUMABLE' %}selected{% endif %}>üì¶ –†–∞—Å—Ö–æ–¥–Ω–∏–∫</option>
            </select>
        </div>

        <div class="col-md-2">
            <label class="form-label small text-body-secondary">–°—Ç–∞—Ç—É—Å</label>
            <select name="status" id="filterStatus" class="form-select form-select-sm">
                <option value="">- –õ—é–±–æ–π -</option>
                <option value="IN_STOCK" {% if request.GET.status == 'IN_STOCK' %}selected{% endif %}>üü¢ –ù–∞ —Å–∫–ª–∞–¥–µ</option>
                <option value="ISSUED" {% if request.GET.status == 'ISSUED' %}selected{% endif %}>üü† –í—ã–¥–∞–Ω–æ</option>
            </select>
        </div>

        <div class="col-md-2">
            <label class="form-label small text-body-secondary">–°–∫–ª–∞–¥</label>
            <select name="warehouse" id="filterWarehouse" class="form-select form-select-sm">
                <option value="">- –í—Å–µ —Å–∫–ª–∞–¥—ã -</option>
                {% for wh in warehouses %}
                    <option value="{{ wh.id }}" {% if request.GET.warehouse == wh.id|stringformat:"s" %}selected{% endif %}>üè† {{ wh.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="col-md-2">
            <label class="form-label small text-body-secondary">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
            <input type="text" name="employee" class="form-control form-control-sm" 
                   value="{{ request.GET.employee }}" 
                   list="employeeListOptions" 
                   placeholder="–ò–º—è –§–∞–º–∏–ª–∏—è...">
            
            <datalist id="employeeListOptions">
                {% for emp in employees %}
                    <option value="{{ emp.get_full_name|default:emp.username }}">
                {% endfor %}
            </datalist>
        </div>
        
        <div class="col-md-1 d-flex gap-1">
            <button type="submit" class="btn btn-primary btn-sm w-100" title="–ù–∞–π—Ç–∏"><i class="fa-solid fa-search"></i></button>
            <a href="{% url 'tool_list' %}" class="btn btn-secondary btn-sm" title="–°–±—Ä–æ—Å">X</a>
        </div>
    </form>
</div>

<div id="tableContainer">
    {% include 'inventory/tool_list_content.html' %}
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        document.body.addEventListener('click', function(e) {
            if (e.target.closest('.ajax-link')) {
                e.preventDefault();
                const url = e.target.closest('.ajax-link').href;
                fetchTable(url);
            }
        });

        const filterForm = document.getElementById('filterForm');
        if (filterForm) {
            filterForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(filterForm);
                const params = new URLSearchParams(formData).toString();
                const url = "{% url 'tool_list' %}?" + params;
                fetchTable(url);
                window.history.pushState(null, '', url);
            });
        }

        function fetchTable(url) {
            const container = document.getElementById('tableContainer');
            container.style.opacity = '0.5';
            fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(response => response.text())
            .then(html => {
                container.innerHTML = html;
                container.style.opacity = '1';
            })
            .catch(err => { console.error(err); container.style.opacity = '1'; });
        }
    });
</script>

{% endblock %}