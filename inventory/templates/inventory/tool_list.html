{% extends 'inventory/base.html' %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3 mt-2 flex-wrap gap-2">
    <h3 style="margin:0;">üì¶ –¢–æ–≤–∞—Ä—ã</h3>
    
    {% if user.is_staff %}
    <div class="d-flex gap-2">
        <a href="{% url 'nomenclature_list' %}" class="btn btn-primary btn-sm shadow-sm">
            <i class="fa-solid fa-book"></i> –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã
        </a>
        <a href="{% url 'print_barcodes' %}" class="btn btn-dark btn-sm shadow-sm">
            <i class="fa-solid fa-print"></i> –ü–µ—á–∞—Ç—å
        </a>
        <a href="{% url 'tool_add' %}" class="btn btn-success btn-sm shadow-sm fw-bold">
            <i class="fa-solid fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
        </a>
    </div>
    {% endif %}
</div>

<div class="filter-box">
    <span class="filter-title">–§–∏–ª—å—Ç—Ä—ã</span>
    <form method="GET" id="filterForm" class="row g-2 align-items-end">
        <div class="col-md-3">
            <label class="form-label small text-body-secondary">–ü–æ–∏—Å–∫</label>
            <input type="text" name="search" class="form-control form-control-sm" value="{{ request.GET.search }}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ / –ò–Ω–≤.‚Ññ">
        </div>
        
        <div class="col-md-2">
            <label class="form-label small text-body-secondary">–¢–∏–ø</label>
            <select name="item_type" id="filterType" class="form-select form-select-sm">
                <option value="">- –í—Å–µ —Ç–∏–ø—ã -</option>
                <option value="TOOL" {% if request.GET.item_type == 'TOOL' %}selected{% endif %}>üî® –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</option>
                <option value="EQUIPMENT" {% if request.GET.item_type == 'EQUIPMENT' %}selected{% endif %}>ü¶∫ –≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞</option>
                <option value="CONSUMABLE" {% if request.GET.item_type == 'CONSUMABLE' %}selected{% endif %}>üì¶ –†–∞—Å—Ö–æ–¥–Ω–∏–∫</option>
            </select>
        </div>

        <div class="col-md-2">
            <label class="form-label small text-body-secondary">–°—Ç–∞—Ç—É—Å</label>
            <select name="status" id="filterStatus" class="form-select form-select-sm">
                <option value="">- –õ—é–±–æ–π -</option>
                <option value="IN_STOCK" {% if request.GET.status == 'IN_STOCK' %}selected{% endif %}>üü¢ –ù–∞ —Å–∫–ª–∞–¥–µ</option>
                <option value="ISSUED" {% if request.GET.status == 'ISSUED' %}selected{% endif %}>üü† –í—ã–¥–∞–Ω–æ</option>
            </select>
        </div>

        <div class="col-md-2">
            <label class="form-label small text-body-secondary">–°–∫–ª–∞–¥</label>
            <select name="warehouse" id="filterWarehouse" class="form-select form-select-sm">
                <option value="">- –í—Å–µ —Å–∫–ª–∞–¥—ã -</option>
                {% for wh in warehouses %}
                    <option value="{{ wh.id }}" {% if request.GET.warehouse == wh.id|stringformat:"s" %}selected{% endif %}>üè† {{ wh.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="col-md-2">
            <label class="form-label small text-body-secondary">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
            <select name="employee" id="filterEmployee" class="form-select form-select-sm">
                <option value="">- –í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ -</option>
                {% for emp in employees %}
                    <option value="{{ emp.id }}" {% if request.GET.employee == emp.id|stringformat:"s" %}selected{% endif %}>üë§ {{ emp.get_full_name|default:emp.username }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="col-md-1 d-flex gap-1">
            <button type="submit" class="btn btn-primary btn-sm w-100" title="–ù–∞–π—Ç–∏"><i class="fa-solid fa-search"></i></button>
            <a href="{% url 'tool_list' %}" class="btn btn-secondary btn-sm" title="–°–±—Ä–æ—Å">X</a>
        </div>
    </form>
</div>

<div id="tableContainer">
    {% include 'inventory/tool_list_content.html' %}
</div>

{% if user.is_staff %}
<div class="modal fade" id="issueModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form method="post" id="issueForm" action="">{% csrf_token %}<div class="modal-header bg-warning"><h5 class="modal-title">–í—ã–¥–∞—á–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>–í—ã–¥–∞–µ–º: <strong id="issueToolName"></strong></p><label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</label><select name="employee_id" class="form-select" required>{% for emp in employees %}<option value="{{ emp.id }}">{{ emp.get_full_name|default:emp.username }}</option>{% endfor %}</select></div><div class="modal-footer"><button class="btn btn-primary w-100">–í—ã–¥–∞—Ç—å</button></div></form></div></div></div>
<div class="modal fade" id="returnModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form method="post" id="returnForm" action="">{% csrf_token %}<div class="modal-header bg-success text-white"><h5 class="modal-title">–í–æ–∑–≤—Ä–∞—Ç –Ω–∞ —Å–∫–ª–∞–¥</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>–í–æ–∑–≤—Ä–∞—Ç: <strong id="returnToolName"></strong></p><label>–ù–∞ —Å–∫–ª–∞–¥:</label><select name="warehouse_id" class="form-select" required>{% for wh in warehouses %}<option value="{{ wh.id }}">{{ wh.name }}</option>{% endfor %}</select></div><div class="modal-footer"><button class="btn btn-success w-100">–í–µ—Ä–Ω—É—Ç—å</button></div></form></div></div></div>
<div class="modal fade" id="toolWriteoffModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form method="post" id="toolWriteoffForm" action="">{% csrf_token %}<div class="modal-header bg-danger text-white"><h5 class="modal-title">–°–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="alert alert-warning small"><i class="fa-solid fa-triangle-exclamation"></i> –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω –∏–∑ —Å–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤!</div><p>–°–ø–∏—Å–∞—Ç—å: <strong id="toolWriteName"></strong></p><p>–ò–Ω–≤. ‚Ññ: <span id="toolWriteInv" class="font-monospace"></span></p><div class="mb-3"><label>–ü—Ä–∏—á–∏–Ω–∞ —Å–ø–∏—Å–∞–Ω–∏—è:</label><textarea name="reason" class="form-control" rows="3" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –£—Ç–µ—Ä—è–Ω, –°–ª–æ–º–∞–Ω –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ–º–æ–Ω—Ç–∞" required></textarea></div></div><div class="modal-footer"><button class="btn btn-danger w-100">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ</button></div></form></div></div></div>
<div class="modal fade" id="consumableIssueModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form method="post" id="consumableIssueForm" action="">{% csrf_token %}<div class="modal-header bg-warning"><h5 class="modal-title">–í—ã–¥–∞—á–∞ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>–¢–æ–≤–∞—Ä: <strong id="consumableName"></strong></p><p class="text-body-secondary small">–î–æ—Å—Ç—É–ø–Ω–æ: <span id="consumableMax"></span></p><div class="mb-3"><label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label><input type="number" name="quantity" id="consumableQty" class="form-control" min="1" required></div><div class="mb-3"><label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</label><select name="employee_id" class="form-select" required>{% for emp in employees %}<option value="{{ emp.id }}">{{ emp.get_full_name|default:emp.username }}</option>{% endfor %}</select></div></div><div class="modal-footer"><button class="btn btn-primary w-100">–í—ã–¥–∞—Ç—å</button></div></form></div></div></div>
<div class="modal fade" id="consumableReturnModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form method="post" id="consumableReturnForm" action="">{% csrf_token %}<div class="modal-header bg-success text-white"><h5 class="modal-title">–í–æ–∑–≤—Ä–∞—Ç —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>–¢–æ–≤–∞—Ä: <strong id="conRetName"></strong></p><p class="text-body-secondary small">–ù–∞ —Ä—É–∫–∞—Ö: <span id="conRetMax"></span></p><div class="mb-3"><label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label><input type="number" name="quantity" id="conRetQty" class="form-control" min="1" required></div><div class="mb-3"><label>–ù–∞ —Å–∫–ª–∞–¥:</label><select name="warehouse_id" class="form-select" required>{% for wh in warehouses %}<option value="{{ wh.id }}">{{ wh.name }}</option>{% endfor %}</select></div></div><div class="modal-footer"><button class="btn btn-success w-100">–í–µ—Ä–Ω—É—Ç—å</button></div></form></div></div></div>
<div class="modal fade" id="consumableWriteoffModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form method="post" id="consumableWriteoffForm" action="">{% csrf_token %}<div class="modal-header bg-danger text-white"><h5 class="modal-title">–°–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>–°–ø–∏—Å–∞—Ç—å: <strong id="conWriteName"></strong></p><p class="text-body-secondary small">–î–æ—Å—Ç—É–ø–Ω–æ: <span id="conWriteMax"></span></p><div class="mb-3"><label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label><input type="number" name="quantity" id="conWriteQty" class="form-control" min="1" required></div><div class="mb-3"><label>–ü—Ä–∏—á–∏–Ω–∞:</label><input type="text" name="reason" class="form-control" placeholder="–°–ª–æ–º–∞–Ω–æ / –ò–∑—Ä–∞—Å—Ö–æ–¥–æ–≤–∞–Ω–æ" required></div></div><div class="modal-footer"><button class="btn btn-danger w-100">–°–ø–∏—Å–∞—Ç—å</button></div></form></div></div></div>

<script>
    const container = document.getElementById('tableContainer');
    const filterForm = document.getElementById('filterForm');

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    function loadData(url) {
        container.style.opacity = '0.5';
        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(response => response.text())
        .then(html => {
            container.innerHTML = html;
            container.style.opacity = '1';
            history.pushState(null, '', url);
        })
        .catch(err => { console.error('–û—à–∏–±–∫–∞:', err); container.style.opacity = '1'; });
    }

    // –ö–ª–∏–∫–∏ –ø–æ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    container.addEventListener('click', function(e) {
        const link = e.target.closest('.ajax-link');
        if (link) {
            e.preventDefault();
            loadData(link.href);
        }
    });

    // –°–∞–±–º–∏—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤
    filterForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(filterForm);
        const queryString = new URLSearchParams(formData).toString();
        loadData(`${window.location.pathname}?${queryString}`);
    });


    // –ú–æ–¥–∞–ª–∫–∏
    function setIssueModal(id, name) { document.getElementById('issueToolName').innerText = name; document.getElementById('issueForm').action = "/tool/" + id + "/issue/"; }
    function setReturnModal(id, name) { document.getElementById('returnToolName').innerText = name; document.getElementById('returnForm').action = "/tool/" + id + "/return/"; }
    function setToolWriteoffModal(id, name, inv) { document.getElementById('toolWriteName').innerText = name; document.getElementById('toolWriteInv').innerText = inv; document.getElementById('toolWriteoffForm').action = "/tool/" + id + "/writeoff/"; }
    function setConsumableIssueModal(id, name, maxQty) { document.getElementById('consumableName').innerText = name; document.getElementById('consumableMax').innerText = maxQty; var i = document.getElementById('consumableQty'); i.max = maxQty; i.value = 1; document.getElementById('consumableIssueForm').action = "/consumable/" + id + "/issue/"; }
    function setConsumableReturnModal(id, name, maxQty) { document.getElementById('conRetName').innerText = name; document.getElementById('conRetMax').innerText = maxQty; var i = document.getElementById('conRetQty'); i.max = maxQty; i.value = 1; document.getElementById('consumableReturnForm').action = "/consumable/" + id + "/return/"; }
    function setConsumableWriteoffModal(id, name, maxQty) { document.getElementById('conWriteName').innerText = name; document.getElementById('conWriteMax').innerText = maxQty; var i = document.getElementById('conWriteQty'); i.max = maxQty; i.value = 1; document.getElementById('consumableWriteoffForm').action = "/consumable/" + id + "/writeoff/"; }
</script>
{% endif %}

{% endblock %}