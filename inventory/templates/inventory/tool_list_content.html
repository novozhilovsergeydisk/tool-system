<h5 class="mt-4 mb-2 text-body-secondary"><i class="fa-solid fa-list"></i> Список товаров</h5>
<div class="card shadow-sm mb-4">
    <div class="card-body p-0 bg-body table-responsive">
        <table class="table table-striped table-hover table-custom mb-0 align-middle">
            <thead>
                <tr>
                    <th>Наименование</th>
                    <th>Артикул</th>
                    <th>Инфо</th>
                    <th>Владелец / Локация</th>
                    <th class="d-none d-md-table-cell">Состояние</th>
                    <th>Статус</th>
                    <th style="min-width: 140px; text-align: center;">Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <td>
                        {% if item.row_type == 'tool' %}<i class="fa-solid fa-hammer text-secondary me-1"></i>
                        {% else %}<i class="fa-solid fa-box text-info me-1"></i>{% endif %}
                        <strong>{{ item.nomenclature.name }}</strong>
                    </td>
                    <td class="text-body-secondary font-monospace small">{{ item.nomenclature.article }}</td>
                    <td>
                        {% if item.row_type == 'tool' %}<span class="badge bg-secondary font-monospace fs-6">{{ item.inventory_id }}</span>
                        {% else %}<span class="badge bg-primary fs-6">{{ item.quantity }} шт.</span>{% endif %}
                    </td>
                    <td>
                        {% if item.row_type == 'tool' %}
                            {% if item.current_holder %}<span class="text-primary small fw-bold"><i class="fa-solid fa-user"></i> {{ item.current_holder.get_full_name|default:item.current_holder.username }}</span>
                            {% elif item.current_warehouse %}<span class="text-body-secondary small"><i class="fa-solid fa-warehouse"></i> {{ item.current_warehouse.name }}</span>
                            {% endif %}
                            {% if item.kit %}<span class="badge bg-warning text-dark ms-1"><i class="fa-solid fa-toolbox"></i> {{ item.kit.name }}</span>{% endif %}
                        {% else %}
                            {% if item.holder %}<span class="text-primary small fw-bold"><i class="fa-solid fa-user"></i> {{ item.holder.get_full_name|default:item.holder.username }}</span>
                            {% elif item.warehouse %}<span class="text-body-secondary small"><i class="fa-solid fa-warehouse"></i> {{ item.warehouse.name }}</span>{% endif %}
                        {% endif %}
                    </td>
                    <td class="d-none d-md-table-cell">
                        {% if item.row_type == 'tool' %}
                            {% if item.condition == 'NEW' %}<span class="badge rounded-pill text-bg-info text-white">Новое</span>
                            {% elif item.condition == 'USED' %}<span class="badge rounded-pill text-bg-warning">Б/У</span>
                            {% elif item.condition == 'BROKEN' %}<span class="badge rounded-pill bg-danger">Сломано</span>{% endif %}
                        {% else %}<span class="text-body-secondary small">-</span>{% endif %}
                    </td>
                    <td>
                        {% if item.row_type == 'tool' %}
                            {% if item.status == 'IN_STOCK' %}<span class="badge bg-success">На складе</span>
                            {% elif item.status == 'ISSUED' %}<span class="badge bg-warning text-dark">Выдано</span>
                            {% elif item.status == 'BROKEN' %}<span class="badge bg-danger">В ремонте</span>{% endif %}
                        {% else %}
                            {% if item.warehouse %}<span class="badge bg-success">На складе</span>
                            {% elif item.holder %}<span class="badge bg-warning text-dark">Выдано</span>{% endif %}
                        {% endif %}
                    </td>

                    <td align="center">
                        <div class="d-flex justify-content-center gap-1">
                            
                            {% if user.is_superuser or perms.inventory.change_toolinstance or perms.inventory.delete_toolinstance %}
                                
                                {% if item.row_type == 'tool' %}
                                    
                                    {% if item.status == 'IN_STOCK' and perms.inventory.change_toolinstance %}
                                        {% if user.is_superuser or item.current_warehouse.id in allowed_ids %}
                                            <button class="btn btn-sm btn-warning text-dark" title="Выдать" onclick="openModal('issueModal', {id: '{{ item.id }}', name: '{{ item.nomenclature.name }}'})"><i class="fa-solid fa-hand-holding"></i></button>
                                        {% endif %}
                                    
                                    {% elif item.status == 'ISSUED' and perms.inventory.change_toolinstance %}
                                        <button class="btn btn-sm btn-success" title="Вернуть" onclick="openModal('returnModal', {id: '{{ item.id }}', name: '{{ item.nomenclature.name }}'})"><i class="fa-solid fa-share"></i></button>
                                    {% endif %}

                                    {% if perms.inventory.change_toolinstance %}
                                        {% if user.is_superuser or item.status == 'ISSUED' or item.current_warehouse.id in allowed_ids %}
                                            <a href="{% url 'tool_edit' item.id %}" class="btn btn-outline-secondary btn-sm" title="Ред."><i class="fa-solid fa-pencil"></i></a>
                                        {% endif %}
                                    {% endif %}

                                    {% if perms.inventory.delete_toolinstance %}
                                        {% if user.is_superuser or item.status == 'ISSUED' or item.current_warehouse.id in allowed_ids %}
                                            <button class="btn btn-sm btn-danger" title="Списать" onclick="openModal('toolWriteoffModal', {id: '{{ item.id }}', name: '{{ item.nomenclature.name }}', inv: '{{ item.inventory_id }}'})"><i class="fa-solid fa-fire"></i></button>
                                        {% endif %}
                                    {% endif %}

                                {% else %}
                                    {% if item.warehouse and item.quantity > 0 %}
                                        {% if user.is_superuser or item.warehouse.id in allowed_ids %}
                                            {% if perms.inventory.change_consumablebalance %}
                                            <button class="btn btn-sm btn-warning text-dark" onclick="openModal('consumableIssueModal', {id: '{{ item.id }}', name: '{{ item.nomenclature.name }}', max: {{ item.quantity }}} )"><i class="fa-solid fa-hand-holding"></i></button>
                                            {% endif %}
                                            {% if perms.inventory.delete_consumablebalance %}
                                            <button class="btn btn-sm btn-danger" onclick="openModal('consumableWriteoffModal', {id: '{{ item.id }}', name: '{{ item.nomenclature.name }}', max: {{ item.quantity }}} )"><i class="fa-solid fa-fire"></i></button>
                                            {% endif %}
                                        {% endif %}
                                    {% elif item.holder and item.quantity > 0 and perms.inventory.change_consumablebalance %}
                                        <button class="btn btn-sm btn-success" onclick="openModal('consumableReturnModal', {id: '{{ item.id }}', name: '{{ item.nomenclature.name }}', max: {{ item.quantity }}} )"><i class="fa-solid fa-share"></i></button>
                                    {% endif %}
                                {% endif %}

                            {% else %}
                                {% if item.row_type == 'tool' %}
                                    {% if item.status == 'IN_STOCK' %}
                                        {% if user.is_superuser or item.current_warehouse.id in allowed_ids %}
                                            <button class="btn btn-sm btn-outline-primary fw-bold" onclick="openModal('takeSelfModal', {id: '{{ item.id }}', name: '{{ item.nomenclature.name }}'})">Взять</button>
                                        {% endif %}
                                    {% elif item.current_holder == user %}
                                        <button class="btn btn-sm btn-outline-success fw-bold" onclick="openModal('returnSelfModal', {id: '{{ item.id }}', name: '{{ item.nomenclature.name }}'})">Вернуть</button>
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="7" class="text-center py-4 text-body-secondary">Товаров не найдено</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if page_obj.has_other_pages %}
    <div class="card-footer bg-body-tertiary py-2">
        <ul class="pagination pagination-sm justify-content-center mb-0">
            {% if page_obj.has_previous %}
                <li class="page-item"><a class="page-link ajax-link" href="?page={{ page_obj.previous_page_number }}&search={{ request.GET.search }}&warehouse={{ request.GET.warehouse }}"><i class="fa-solid fa-chevron-left"></i></a></li>
            {% endif %}
            <li class="page-item disabled"><span class="page-link">Стр. {{ page_obj.number }}</span></li>
            {% if page_obj.has_next %}
                <li class="page-item"><a class="page-link ajax-link" href="?page={{ page_obj.next_page_number }}&search={{ request.GET.search }}&warehouse={{ request.GET.warehouse }}"><i class="fa-solid fa-chevron-right"></i></a></li>
            {% endif %}
        </ul>
    </div>
    {% endif %}
</div>

{% if user.is_superuser or perms.inventory.change_toolinstance or perms.inventory.delete_toolinstance %}
    <div class="modal fade" id="issueModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form method="post" id="issueForm" action="">{% csrf_token %}<div class="modal-header bg-warning"><h5 class="modal-title">Выдача</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Выдаем: <strong id="issueToolName"></strong></p><label>Сотрудник:</label><select name="employee_id" class="form-select" required>{% for emp in employees %}<option value="{{ emp.id }}">{{ emp.get_full_name|default:emp.username }}</option>{% endfor %}</select></div><div class="modal-footer"><button class="btn btn-primary">Выдать</button></div></form></div></div></div>
    
    <div class="modal fade" id="returnModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form method="post" id="returnForm" action="">{% csrf_token %}<div class="modal-header bg-success text-white"><h5 class="modal-title">Возврат</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Возврат: <strong id="returnToolName"></strong></p><label>На склад:</label>
        <select name="warehouse_id" class="form-select" required>
            {% for wh in allowed_whs %}
                <option value="{{ wh.id }}">{{ wh.name }}</option>
            {% empty %}
                <option disabled>Нет доступных складов</option>
            {% endfor %}
        </select>
    </div><div class="modal-footer"><button class="btn btn-success">Вернуть</button></div></form></div></div></div>
    
    <div class="modal fade" id="toolWriteoffModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form method="post" id="toolWriteoffForm" action="">{% csrf_token %}<div class="modal-header bg-danger text-white"><h5 class="modal-title">Списание</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Списать: <strong id="toolWriteName"></strong></p><p>Инв. №: <span id="toolWriteInv"></span></p><div class="mb-3"><label>Причина:</label><textarea name="reason" class="form-control" rows="3" required></textarea></div></div><div class="modal-footer"><button class="btn btn-danger">Подтвердить</button></div></form></div></div></div>

    <div class="modal fade" id="consumableIssueModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form method="post" id="consumableIssueForm" action="">{% csrf_token %}<div class="modal-header bg-warning"><h5 class="modal-title">Выдача расходников</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Товар: <strong id="consumableName"></strong></p><p class="small">Макс: <span id="consumableMax"></span></p><input type="number" name="quantity" id="consumableQty" class="form-control mb-3" min="1" required><select name="employee_id" class="form-select" required>{% for emp in employees %}<option value="{{ emp.id }}">{{ emp.get_full_name|default:emp.username }}</option>{% endfor %}</select></div><div class="modal-footer"><button class="btn btn-primary">Выдать</button></div></form></div></div></div>
    <div class="modal fade" id="consumableReturnModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form method="post" id="consumableReturnForm" action="">{% csrf_token %}<div class="modal-header bg-success text-white"><h5 class="modal-title">Возврат расходников</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Товар: <strong id="conRetName"></strong></p><p class="small">Макс: <span id="conRetMax"></span></p><input type="number" name="quantity" id="conRetQty" class="form-control mb-3" min="1" required><select name="warehouse_id" class="form-select" required>{% for wh in allowed_whs %}<option value="{{ wh.id }}">{{ wh.name }}</option>{% endfor %}</select></div><div class="modal-footer"><button class="btn btn-success">Вернуть</button></div></form></div></div></div>
    <div class="modal fade" id="consumableWriteoffModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form method="post" id="consumableWriteoffForm" action="">{% csrf_token %}<div class="modal-header bg-danger text-white"><h5 class="modal-title">Списание расходников</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Товар: <strong id="conWriteName"></strong></p><p class="small">Макс: <span id="conWriteMax"></span></p><input type="number" name="quantity" id="conWriteQty" class="form-control mb-3" min="1" required><input type="text" name="reason" class="form-control" placeholder="Причина" required></div><div class="modal-footer"><button class="btn btn-danger">Списать</button></div></form></div></div></div>

{% else %}
    <div class="modal fade" id="takeSelfModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form method="post" id="takeSelfForm" action="">{% csrf_token %}<div class="modal-header bg-primary text-white"><h5 class="modal-title">Взять</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p><strong id="takeSelfName"></strong></p><textarea name="comment" class="form-control" placeholder="Комментарий"></textarea></div><div class="modal-footer"><button class="btn btn-primary w-100">Взять</button></div></form></div></div></div>
    <div class="modal fade" id="returnSelfModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><form method="post" id="returnSelfForm" action="">{% csrf_token %}<div class="modal-header bg-success text-white"><h5 class="modal-title">Вернуть</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p><strong id="returnSelfName"></strong></p><textarea name="comment" class="form-control" placeholder="Комментарий"></textarea></div><div class="modal-footer"><button class="btn btn-success w-100">Вернуть</button></div></form></div></div></div>
{% endif %}

<script>
    // УНИВЕРСАЛЬНАЯ ФУНКЦИЯ ДЛЯ ОТКРЫТИЯ МОДАЛОК (БЕЗ JQUERY)
    function openModal(modalId, data) {
        var modalEl = document.getElementById(modalId);
        if (!modalEl) return;

        // Заполняем данные
        if (data.id) {
            // ИНСТРУМЕНТ
            if (modalId === 'issueModal') {
                document.getElementById('issueToolName').innerText = data.name;
                document.getElementById('issueForm').action = "/tool/" + data.id + "/issue/";
            } else if (modalId === 'returnModal') {
                document.getElementById('returnToolName').innerText = data.name;
                document.getElementById('returnForm').action = "/tool/" + data.id + "/return/";
            } else if (modalId === 'toolWriteoffModal') {
                document.getElementById('toolWriteName').innerText = data.name;
                document.getElementById('toolWriteInv').innerText = data.inv;
                document.getElementById('toolWriteoffForm').action = "/tool/" + data.id + "/writeoff/";
            } else if (modalId === 'takeSelfModal') {
                document.getElementById('takeSelfName').innerText = data.name;
                document.getElementById('takeSelfForm').action = "/tool/" + data.id + "/take_self/";
            } else if (modalId === 'returnSelfModal') {
                document.getElementById('returnSelfName').innerText = data.name;
                document.getElementById('returnSelfForm').action = "/tool/" + data.id + "/return_self/";
            }
            // РАСХОДНИКИ
            else if (modalId === 'consumableIssueModal') {
                document.getElementById('consumableName').innerText = data.name;
                document.getElementById('consumableMax').innerText = data.max;
                var inp = document.getElementById('consumableQty'); inp.max = data.max; inp.value = 1;
                document.getElementById('consumableIssueForm').action = "/consumable/" + data.id + "/issue/";
            } else if (modalId === 'consumableReturnModal') {
                document.getElementById('conRetName').innerText = data.name;
                document.getElementById('conRetMax').innerText = data.max;
                var inp = document.getElementById('conRetQty'); inp.max = data.max; inp.value = 1;
                document.getElementById('consumableReturnForm').action = "/consumable/" + data.id + "/return/";
            } else if (modalId === 'consumableWriteoffModal') {
                document.getElementById('conWriteName').innerText = data.name;
                document.getElementById('conWriteMax').innerText = data.max;
                var inp = document.getElementById('conWriteQty'); inp.max = data.max; inp.value = 1;
                document.getElementById('consumableWriteoffForm').action = "/consumable/" + data.id + "/writeoff/";
            }
        }

        // Открываем через Bootstrap API
        var modal = new bootstrap.Modal(modalEl);
        modal.show();
    }
</script>